<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Orders Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h2>Service Orders Dashboard</h2>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Customer Name</th>
            <th scope="col">Email</th>
            <th scope="col">Phone</th>
            <th scope="col">Priority</th>
            <th scope="col">Service Type</th>
            <th scope="col">Creation Date</th>
            <th scope="col">Pickup Date</th>
            <th scope="col">Comments</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="serviceOrdersTableBody">
          <!-- Service orders will be loaded here by JavaScript -->
        </tbody>
      </table>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      // JavaScript to fetch and display orders
      document.addEventListener("DOMContentLoaded", () => {
        fetchServiceOrders();

        // Function to fetch service orders and populate the table
        async function fetchServiceOrders() {
          try {
            const response = await fetch("/api/registrations", {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });

            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }

            const orders = await response.json();
            const ordersTableBody = document.getElementById(
              "serviceOrdersTableBody"
            );
            ordersTableBody.innerHTML = ""; // Clear the table body

            // Populate table with orders
            orders.forEach((order) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <th scope="row">${order.id}</th>
                            <td>${order.customerName}</td>
                            <td>${order.email}</td>
                            <td>${order.phoneNumber}</td>
                            <td>${order.priority}</td>
                            <td>${order.serviceType}</td>
                            <td>${new Date(
                              order.creationDate
                            ).toLocaleDateString()}</td>
                            <td>${new Date(
                              order.pickupDate
                            ).toLocaleDateString()}</td>
                            <td class="comment-cell">${order.comments}</td>
                            <td>
                                <button class="btn btn-primary btn-sm edit-btn" data-id="${
                                  order.id
                                }">Edit</button>
                                <button class="btn btn-success btn-sm save-btn d-none" data-id="${
                                  order.id
                                }">Save</button>
                                <button class="btn btn-secondary btn-sm cancel-btn d-none" data-id="${
                                  order.id
                                }">Cancel</button>
                            </td>
                        `;
              ordersTableBody.appendChild(row);
            });

            attachEditEventListeners();
          } catch (error) {
            console.error(
              "There has been a problem with your fetch operation:",
              error
            );
          }
        }

        function attachEditEventListeners() {
          document.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const orderId = e.target.getAttribute("data-id");
              const parentRow = e.target.closest("tr");
              const commentCell = parentRow.querySelector(".comment-cell"); // Stellen Sie sicher, dass Sie eine Klasse 'comment-cell' in Ihrer Tabellenzelle haben.

              // Ersetzen Sie den Text in der Kommentarzelle durch ein Eingabefeld
              const originalContent = commentCell.innerText;
              commentCell.innerHTML = `<input type="text" value="${originalContent}" class="form-control comment-input">`;

              // Zeigen Sie die Speicher- und Abbrechen-Tasten an
              parentRow.querySelector(".save-btn").classList.remove("d-none");
              parentRow.querySelector(".cancel-btn").classList.remove("d-none");
              // Verstecken Sie die Bearbeiten-Taste
              e.target.classList.add("d-none");
            });
          });

          // Speicher-Button-Funktionalit채t
          document.querySelectorAll(".save-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const orderId = e.target.getAttribute("data-id");
              const parentRow = e.target.closest("tr");
              const commentInput =
                parentRow.querySelector(".comment-input").value; // Hier wird der Wert aus dem Eingabefeld gelesen

              try {
                const response = await fetch("/api/registrations/" + orderId, {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: JSON.stringify({ comment: commentInput }),
                });

                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }

                // Nach erfolgreichem Speichern aktualisieren Sie den Text der Kommentarzelle
                const commentCell = parentRow.querySelector("td:nth-child(9)");
                commentCell.innerText = commentInput;

                // Verstecken Sie die Speicher- und Abbrechen-Tasten und zeigen Sie die Bearbeiten-Taste wieder an
                parentRow.querySelector(".edit-btn").classList.remove("d-none");
                parentRow.querySelector(".save-btn").classList.add("d-none");
                parentRow.querySelector(".cancel-btn").classList.add("d-none");
              } catch (error) {
                console.error("Error updating comment:", error);
                alert("An unexpected error occurred. Please try again.");
              }
            });
          });

          // Abbrechen-Button-Funktionalit채t
          document.querySelectorAll(".cancel-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const parentRow = e.target.closest("tr");
              fetchServiceOrders(); // Dies setzt die Reihe auf den urspr체nglichen Zustand zur체ck
            });
          });
        }
      });
    </script>
  </body>
</html>
